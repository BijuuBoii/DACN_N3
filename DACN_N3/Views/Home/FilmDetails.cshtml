@*
    
*@
@using DACN_N3.Data
@{
	ViewData["Title"] = "Film details";
	var Movie = ViewBag.Movie as Movie ?? new Movie();
	var Seasons = ViewBag.Seasons as List<Season> ?? new List<Season>();
	var Episodes = ViewBag.Episodes as List<Episode> ?? new List<Episode>();

	// Lấy SeasonId từ ViewBag nếu có
	var selectedSeasonNumber = ViewBag.SeasonNumber != null ? (int)ViewBag.SeasonNumber : Seasons.FirstOrDefault()?.SeasonNumber;
	var seasonId = Seasons
		.Where(i => i.SeasonNumber == selectedSeasonNumber)
		.Select(i => i.SeasonId)
		.FirstOrDefault();

	// Lấy tập đầu tiên trong mùa đã chọn
	var selectedEpisode = Episodes
		.Where(e => e.SeasonId == seasonId)
		.FirstOrDefault();

	// Nếu không có tập nào, thì chọn tập đầu tiên của tất cả các tập
	if (selectedEpisode == null)
	{
		selectedEpisode = Episodes.FirstOrDefault();
	}
}

<section class="banner">
	<div class="ratio ratio-21x9">
		@* <video width="4000" height="800" controls>
			<source src="https://hvuheduvn-my.sharepoint.com/:v:/g/personal/2105ct0096_dhv_edu_vn/ESBIguJcA4FDgc8y_LWW2zoBZygyR6sOErpI7IpEFeyzwA?e=GqmVMb&nav=eyJyZWZlcnJhbEluZm8iOnsicmVmZXJyYWxBcHAiOiJTdHJlYW1XZWJBcHAiLCJyZWZlcnJhbFZpZXciOiJTaGFyZURpYWxvZy1MaW5rIiwicmVmZXJyYWxBcHBQbGF0Zm9ybSI6IldlYiIsInJlZmVycmFsTW9kZSI6InZpZXcifX0%3D" type="video/mp4">
			Trình duyệt bạn không hỗ trợ loại video này.
		</video> *@

		<iframe src="@selectedEpisode?.VideoUrl" width="640" height="360" frameborder="0" scrolling="no" allowfullscreen ></iframe>
		
	</div>
	<div class="container" style="padding-top: 20px; color:white;">
		<h2>@Movie.Title tập 1</h2>
		<br /><br />
		
		<div class="d-flex justify-content-between align-item-center">
			<h2>CÁC TẬP</h2>
			<form method="post" action="@Url.Action("UpdateFilmDetails", "Home")">
                <input type="hidden" name="id" value="@Movie.MovieId" />
                <div class="btn-group">
                    <select name="seasonNumber" class="form-select" onchange="this.form.submit()">
                        <option value="">Chọn mùa</option>
                        @foreach(var season in Seasons)
                        {
                            <option value="@season.SeasonNumber">@season.SeasonNumber</option>
                        }    
                    </select>
                </div>
            </form>
		</div>
		<br />
		<div class="border rounded-3" style="padding: 20px;">
			@foreach (var ep in Episodes
					.Where(s => s.SeasonId == Seasons
					.Where(i => i.SeasonNumber == ViewBag.SeasonNumber)
					.Select(i => i.SeasonId)
					.FirstOrDefault())
					.ToList())
			{
				<button type="button" class="btn btn-light ep"
						data-episode-id="@ep.EpisodeId"
						data-video-url="@ep.VideoUrl"
						data-episode-number="@ep.EpisodeNumber">
					<!-- Thêm thuộc tính này -->
					@ep.EpisodeNumber
				</button>
			}
		</div>
	</div>
	<div class="container" style="padding-top: 20px">
		<div class="border border-light rounded">
			<div class="row align-self-center">
				<div class="col-4">
					<img src="~/img/@Movie.Poster" alt="@Movie.Title poster" />
				</div>
				<div class="col-8" style="color:white;">
					<h1>@Movie.Title</h1>
					<span>Nội dung: @Movie.Description</span>
					<h6>Ngôn ngữ: @Movie.Language</h6>
					<h6>Ngày ra mắt: @Movie.ReleaseDate</h6>
					<h6>Đánh giá độ tuổi: @Movie.AgeRating</h6>
					<h6>Thời lượng phim: @Movie.Duration</h6>
					<h6>Đạo diễn: @Movie.Director</h6>
				</div>
			</div>
		</div>
		
	</div>
	<div class="container" style="padding-top:30px">
		<div class="py-2 px-4 mb-4 rounded-lg border bg-zinc-800 border-zinc-700">
			<label for="comment" class="form-label text-white">Bình luận</label>
			<textarea id="comment" rows="2" class="form-control border-0 text-white placeholder-zinc-400 bg-zinc-800" placeholder="Để lại bình luận..." required></textarea>
			<button type="submit" class="inline-flex items-center mt-2 py-2 px-3 text-xs font-medium text-center text-black bg-zinc-700 rounded-lg hover:opacity-90">Bình Luận</button>
		</div>
		
	</div>
</section>

<script>
	document.addEventListener("DOMContentLoaded", function () {
		// Lấy tất cả các nút tập phim
		const episodeButtons = document.querySelectorAll(".ep");

		episodeButtons.forEach(button => {
			button.addEventListener("click", function () {
				// Lấy ID và thông tin của tập phim từ thuộc tính data-*
				const episodeId = this.getAttribute("data-episode-id");
				const videoUrl = this.getAttribute("data-video-url");
				const episodeNumber = this.getAttribute("data-episode-number");

				// Cập nhật src của iframe
				const iframe = document.querySelector("iframe");
				iframe.src = videoUrl;

				// Cập nhật tiêu đề phim
				const titleElement = document.querySelector("h2");
				titleElement.textContent = `@Movie.Title tập ${episodeNumber}`;
			});
		});
		
	});
</script>

